---
title: "Cortisol, oxytocin and social challenges in pigs"
subtitle: "Part 2: Behavioral analyses "
author: "Liza R. Moscovice, Anja Eggert and Ulrike Gimsa"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: show
    toc: true
    toc_depth: 3
    toc_float: true
---

```{r setup, include=FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

# include = FALSE prevents code and results from appearing in the finished file, but code runs.
# echo = FALSE prevents code, but not the results from appearing in the finished file.
# message = FALSE prevents messages that are generated by code from appearing in the finished file.
# warning = FALSE prevents warnings that are generated by code from appearing in the finished.
```

```{r libraries}
library(knitr)       # to render the document
library(kableExtra)  # nice html tables
library(tidyverse)   # load the tidyverse universe
library(rstatix)     # friedman_test(), wilcox_test()
library(patchwork)   # to combine subplots
```

```{r theme}
my_theme = theme_classic() +
  theme(axis.title = element_text(face="bold", size=10),
        axis.text  = element_text(size=10, angle = 0, vjust = 0.5),
        plot.title = element_text(face="bold", size=10),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())
```

# Data &  summary statistics

Here we read in the data table `prosocial-pigs-behavior-1.csv` and make some adjustments of the data format.

* change from character to factor: `uniq.group`
* change from character to ordered factor: `context`

Calculation of median values of `agonistic.inter`, `locomotor.play` and `prop.active` for each level of `context`. 

```{r}
dat.beha1 <- read_csv(file = "./data/prosocial-pigs-behavior-1.csv")  

dat.beha1 <- dat.beha1                                                %>% 
  mutate(uniq.group = factor(uniq.group))                             %>% 
  mutate(context    = factor(context,
                             levels=c("Baseline", "Weaning","Play")))

sum.beha1 <- dat.beha1 %>% 
  group_by(context) %>% 
  summarise(across(
    .cols = where(is.numeric), 
    .fns = list(mean = mean,
                sd = sd,
                median = median), na.rm = TRUE, 
    .names = "{col}_{fn}"
    )) %>% 
  mutate_if(is.numeric, round, 2)

sum.beha1 %>% 
  tibble::rowid_to_column("#") %>% 
  kable(caption = "Summary statistics") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 10) %>% 
  scroll_box(width = "800px", height = "200px")
```

\ 

# Fig 4: Group behaviors

## Statistical analysis

1. Omnibus Friedman Rank Sum Test, which is the non-parametric alternative to the one-way repeated measures ANOVA test
2. Wilcoxon as post hoc test, with p adjustments for multiple comparisons

### Fig 4a) Agnostic interactions

```{r}
# Friedman test
# it only takes full blocks, i.e. we need to remove DG-2_W
# need to re-define the levels without DG-2_W (otherwise it remains as a ghost entry)
dat.beha1 %>% 
  filter(uniq.group != "DG-2_W") %>% 
  mutate(uniq.group  = factor(uniq.group,
                             levels=c("DG-2_F","DG-3_F","DG-3_W","DG-4_F",
                                      "DG-4_W","DG-5_F","DG-5_W"))) %>% 
  rstatix::friedman_test(agonistic.inter ~ context | uniq.group)

# Wilcox test
dat.beha1 %>% 
  wilcox_test(agonistic.inter ~ context,
              paired = TRUE,
              p.adjust.method = "bonferroni")

# add letters to summary table (manually)
sum.beha1 <- sum.beha1 %>% 
  mutate(wilcox_agn.int  = c("ab", "a", "b"))
```

\ 

### Fig 4b) Locomotor play

```{r}
# Friedman test
# it only takes full blocks, i.e. we need to remove DG-2_W
# need to re-define the levels without DG-2_W (otherwise it remains as a ghost entry)
dat.beha1 %>% 
  filter(uniq.group != "DG-2_W") %>% 
  mutate(uniq.group  = factor(uniq.group,
                             levels=c("DG-2_F","DG-3_F","DG-3_W","DG-4_F",
                                      "DG-4_W","DG-5_F","DG-5_W"))) %>% 
  rstatix::friedman_test(locomotor.play ~ context | uniq.group)

# Wilcox test
dat.beha1 %>%
  wilcox_test(locomotor.play ~ context,
              paired = TRUE,
              p.adjust.method = "bonferroni")

# add letters to summary table (manually)
sum.beha1 <- sum.beha1 %>% 
  mutate(wilcox_loc.play  = c("a", "a", "b"))
```

\ 

## Figures

```{r}
# x axis
xlabs.cont <- c("Baseline \n(7 groups)","Weaning \n(8 groups)","Play \n(8 groups)")

# agnostic interactions
p1 <- dat.beha1 %>% 
  ggplot() +
  geom_boxplot(aes(x = context, y = agonistic.inter), outlier.shape = NA, width = 0.5) +
  geom_jitter(aes(x = context, y = agonistic.inter, col = context), size = 2, width = 0.15, alpha = 0.5) +
  scale_colour_manual("Social context",
                      values = c("grey60", "firebrick", "navy"))+
  scale_y_continuous(lim = c(0, 1.01), breaks = seq(0, 1, 0.2)) +
  scale_x_discrete(labels= xlabs.cont) +
  geom_text(data = sum.beha1, col="black",
            aes(y=agonistic.inter_median, x=as.numeric(context)+0.3, label=wilcox_agn.int, hjust = 0)) +
  labs(x = "",
       y = c(expression(paste("Group rates of behavior (", min^-1, ")"))),
       title = "Agonistic interactions") +
  my_theme +
  theme(legend.position = 'none')
  

# locomotion play
p2 <- dat.beha1 %>% 
  ggplot() +
  geom_boxplot(aes(x = context, y = locomotor.play), outlier.shape = NA, width = 0.5) +
  geom_jitter(aes(x = context, y = locomotor.play, col = context), size = 2, width = 0.15, alpha = 0.5) +
  scale_colour_manual("Social context",
                      values = c("grey60", "firebrick", "navy"))+
  scale_y_continuous(lim = c(0, 4.5), breaks = seq(0, 4.5, 1)) +
  scale_x_discrete(labels= xlabs.cont) +
  geom_text(data = sum.beha1, col="black",
            aes(y=locomotor.play_median, x=as.numeric(context)+0.3, label=wilcox_loc.play, hjust = 0)) +
  labs(x = "",
       y = "",
       title = "Locomotor play") +
  my_theme +
  theme(legend.position = 'none')

# combine
patchwork <- p1 + p2

patchwork +
  plot_layout(ncol = 2) +
  plot_annotation(tag_levels = 'A',
                  tag_prefix = '(',
                  tag_suffix = ')') &
  theme(plot.tag = element_text(face = 'bold'))
```

\ 

# Fig 5: Proportions active

## Data set

The necessary data are also included in the table `prosocial-pigs-behavior-1.csv`. The median of `prop.active` for each level of `context` is already calculated.

## Statistical analysis

1. Omnibus Friedman Rank Sum Test, which is the non-parametric alternative to the one-way repeated measures ANOVA test
2. Wilcoxon as post hoc test, with p adjustments for multiple comparisons

```{r}
# Friedman test
# it only takes full blocks, i.e. we need to remove DG-2_W
# need to re-define the levels without DG-2_W (otherwise it remains as a ghost entry)
dat.beha1 %>% 
  filter(uniq.group != "DG-2_W") %>% 
  mutate(uniq.group  = factor(uniq.group,
                             levels=c("DG-2_F","DG-3_F","DG-3_W","DG-4_F",
                                      "DG-4_W","DG-5_F","DG-5_W"))) %>% 
  rstatix::friedman_test(prop.active ~ context | uniq.group)

# Wilcox test
dat.beha1 %>%
  wilcox_test(prop.active ~ context,
              paired = TRUE,
              p.adjust.method = "bonferroni")

# add letters to summary table (manually)
sum.beha1 <- sum.beha1 %>% 
  mutate(wilcox_prop.act  = c("a", "b", "b"))
```

\ 

## Figure

```{r}
# x axis
xlabs.cont <- c("Baseline \n(7 groups)","Weaning \n(8 groups)","Play \n(8 groups)")

# prop active
dat.beha1 %>% 
  ggplot() +
  geom_boxplot(aes(x = context, y = prop.active), outlier.shape = NA, width = 0.5) +
  geom_jitter(aes(x = context, y = prop.active, col = context), size = 2, width = 0.15, alpha = 0.5) +
  scale_colour_manual("Social context",
                      values = c("grey60", "firebrick", "navy"))+
  scale_y_continuous(lim = c(0, 1), breaks = seq(0, 1, 0.2)) +
  scale_x_discrete(labels= xlabs.cont) +
  geom_text(data = sum.beha1, col="black",
            aes(y=prop.active_median, x=as.numeric(context)+0.3, label=wilcox_prop.act, hjust = 0)) +
  labs(x = "",
       y = c(expression(paste("Proportion scans active"))),
       title = "Activity levels") +
  my_theme +
  theme(legend.position = 'none')
```

\ 

# Fig 6: Social interactions during reunion

## Data set

Here we read in the data table `prosocial-pigs-behavior-2.csv` and make some adjustments of the data format.

* change from character to ordered factor: `social.interactions`

Calculation of median values for each level of `social.interactions`.

```{r}
dat.beha2 <- read_csv(file = "./data/prosocial-pigs-behavior-2.csv")  

dat.beha2 <- dat.beha2                                                     %>% 
  mutate(social.interactions = factor(social.interactions,
                                      levels=c("Friendly", "Aggressive")))

sum.beha2 <- dat.beha2 %>% 
  group_by(social.interactions) %>% 
  summarise_at(c("frequency"), median, na.rm = TRUE)
```

\ 

## Figure

```{r}
# x axis
xlabs.social.int <- c("Friendly \n(n=74)","Agonistic \n(n=74)")

# social interactions
dat.beha2 %>% 
  ggplot() +
  geom_boxplot(aes(x = social.interactions, y = frequency), outlier.shape = NA, width = 0.5) +
  geom_jitter(aes(x = social.interactions, y = frequency, shape = social.interactions), size = 2, width = 0.15, alpha = 0.5, col = "navy") +
  scale_y_continuous(lim = c(0, 2), breaks = seq(0, 2, 0.5)) +
  scale_x_discrete(labels= xlabs.social.int) +
  labs(x = "",
       y = c(expression(paste("Individual rates of behavior (", min^-1, ")"))),
       title = "Reunion") +
  my_theme +
  theme(legend.position = 'none')
```

\ 


# Session Info

```{r}
sessionInfo()
```




